name: Build x86_64 Linux Binary

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  actions: write
  contents: read

on:
  workflow_dispatch:

jobs:
  build-x64-linux:
    runs-on: ubuntu-latest
    container:
      image: debian:11

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install packages with retry
        run: |
          # å®‰è£…å¤šä¸ªåŒ…ï¼Œæœ€å¤šé‡è¯•3æ¬¡
          PACKAGES="build-essential cmake wget gcc g++ make upx-ucl binutils libcurl4-openssl-dev libssl-dev libcrypto++-dev zlib1g-dev libkrb5-dev file"

          for i in 1 2 3; do
            echo "Attempt $i: Installing $PACKAGES"
            if apt-get update && apt-get install -y $PACKAGES; then
              echo "âœ… All packages installed"
              break
            fi
            echo "âŒ Attempt $i failed"
            sleep 3
          done

      - name: Build libcurl
        run: |
          wget https://curl.se/download/curl-8.8.0.tar.gz
          tar -xzf curl-8.8.0.tar.gz
          cd curl-8.8.0
          
          ./configure \
            --disable-shared \
            --enable-static \
            --without-gssapi \
            --without-libpsl \
            --without-libssh2 \
            --without-nghttp2 \
            --without-brotli \
            --without-zstd \
            --without-libidn2 \
            --without-ldap \
            --without-ldaps \
            --without-rtsp \
            --without-dict \
            --without-telnet \
            --without-tftp \
            --without-pop3 \
            --without-imap \
            --without-smb \
            --without-smtp \
            --without-gopher \
            --without-mqtt \
            --without-ftp \
            --without-zlib \
            --with-ssl \
            --prefix=/usr/local
          
          make -j$(nproc)
          make install
          
          # æ›´æ–° CMake æŸ¥æ‰¾è·¯å¾„
          export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH
          cd ..

      - name: Build ESurfingClient
        run: |
          echo "ğŸ—ï¸ Starting x64 Linux build process"
          echo "ğŸ“ Go to esurfing dir"
          cd esurfing
          
          echo "âš™ï¸ CMake configuring"
          cmake -DBUILD_STATIC=ON .
          
          echo "ğŸ”¨ Making Programme"
          make -j$(nproc)
          
          echo "ğŸ“¦ Moved ESurfingClient to root dir"
          mv bin/ESurfingClient ../ESurfingClient-x86_64-linux
          
          echo "ğŸ›¡ï¸ Protect1 - Strip binary"
          strip --strip-all ../ESurfingClient-x86_64-linux
          
          echo "ğŸ“¦ Protect2 - Compress with UPX"
          upx --best ../ESurfingClient-x86_64-linux
          
          echo "âœ… Build completed successfully"

      - name: Verify build output
        run: |
          echo "ğŸ” Verifying build output"
          if [ -f "ESurfingClient-x86_64-linux" ]; then
            echo "âœ… Binary file exists"
            ls -la ESurfingClient-x86_64-linux
            file ESurfingClient-x86_64-linux
            echo "ğŸ“ File size: $(du -h ESurfingClient-x86_64-linux | cut -f1)"
          else
            echo "âŒ Binary file not found"
            exit 1
          fi

      - name: Create package
        run: |
          echo "ğŸ“¦ Creating package"
          
          # Create compressed package with executable in root
          tar -czf esurfingclient-x64-linux.tar.gz ESurfingClient-x86_64-linux
          
          echo "ğŸ“¦ Package created: esurfingclient-x64-linux.tar.gz"
          ls -la esurfingclient-x64-linux.tar.gz

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: esurfingclient-x64-linux
          path: |
            ESurfingClient-x86_64-linux
          retention-days: 30