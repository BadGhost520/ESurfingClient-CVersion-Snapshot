name: Build OpenWrt IPK Packages

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        openwrt_version:
          - version: "21.02.7"
            gcc: "8.4.0"
          - version: "23.05.0"
            gcc: "12.3.0"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils rsync unzip wget curl
    
    - name: Cache OpenWrt SDK
      uses: actions/cache@v3
      with:
        path: openwrt-sdk-${{ matrix.openwrt_version.version }}-ramips-mt7621_gcc-${{ matrix.openwrt_version.gcc }}_musl.Linux-x86_64.tar.xz
        key: openwrt-sdk-${{ matrix.openwrt_version.version }}-${{ matrix.openwrt_version.gcc }}
        
    - name: Download OpenWrt SDK
      run: |
        filename="openwrt-sdk-${{ matrix.openwrt_version.version }}-ramips-mt7621_gcc-${{ matrix.openwrt_version.gcc }}_musl.Linux-x86_64.tar.xz"
        if [[ ! -f "$filename" ]]; then
          echo "Downloading OpenWrt SDK ${{ matrix.openwrt_version.version }}"
          wget "https://mirrors.sustech.edu.cn/openwrt/releases/${{ matrix.openwrt_version.version }}/targets/ramips/mt7621/$filename"
        else
          echo "Using cached SDK"
        fi
        
    - name: Extract and setup SDK
      run: |
        filename="openwrt-sdk-${{ matrix.openwrt_version.version }}-ramips-mt7621_gcc-${{ matrix.openwrt_version.gcc }}_musl.Linux-x86_64.tar.xz"
        echo "Remove existing openwrt-sdk dir"
        rm -rf openwrt-sdk
        echo "Extracting SDK"
        tar -xf "$filename"
        echo "Rename SDK dir"
        mv "openwrt-sdk-${{ matrix.openwrt_version.version }}-ramips-mt7621_gcc-${{ matrix.openwrt_version.gcc }}_musl.Linux-x86_64" openwrt-sdk
        
    - name: Prepare package sources
      run: |
        echo "Copy esurfingclient package to dl dir"
        tar -czf esurfingclient.tar.gz esurfing
        mv esurfingclient.tar.gz openwrt-sdk/dl/
        echo "Copy esurfing package to package dir"
        cp -r esurfingclient openwrt-sdk/package/
        echo "Copy menuconfig and cover .config"
        cp menuconfig.config openwrt-sdk/.config
        
    - name: Update feeds
      run: |
        cd openwrt-sdk
        echo "Updating feeds"
        scripts/feeds update -a
        echo "Installing feeds packages"
        scripts/feeds install -a
        
    - name: Build dependencies
      run: |
        cd openwrt-sdk
        echo "Making curl package"
        make package/curl/compile V=sc -j$(nproc)
        echo "Making openssl package"
        make package/openssl/compile V=sc -j$(nproc)
        
    - name: Build ESurfingClient package
      run: |
        cd openwrt-sdk
        echo "Making esurfingclient package"
        make package/esurfingclient/compile V=sc -j$(nproc)
        
    - name: Copy build artifacts
      run: |
        cd openwrt-sdk
        mkdir -p ../artifacts
        cp bin/packages/mipsel_24kc/base/esurfingclient_*.ipk ../artifacts/esurfingclient-mipsel_24kc-openwrt-${{ matrix.openwrt_version.version }}-1.0.1.ipk
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: esurfingclient-openwrt-${{ matrix.openwrt_version.version }}
        path: artifacts/*.ipk
        retention-days: 30
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/**/*.ipk
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}